# plant-monitor

## .env file content

| Variable                  | Mandatory |  type  |                            Description                                |
|---------------------------|-----------|--------|-----------------------------------------------------------------------|
| `THERMISTOR`              |   True    | `bool` | Thermistor is present(true) or should be mocked                       |
| `PHOTORESISTOR`           |   True    | `bool` | Photoresistor is present(true) or should be mocked                    |
| `CAMERA`                  |   True    | `bool` | USB camera is present(true) or should be mocked                       |
| `FONT_SIZE_RATIO`         |   False   | `int`  | default `5`, timestamp font size, relative to picture height          |
| `MAILBOX`                 |   True    | `str`  | mailbox name to use - supported: `GMAIL`, `AWS`, `MOCK`- more below   |


### Notification variables
Two ways of sending e-mails are supported. Select one with `MAILBOX` variable.

#### Gmail notifications
1. Sender account requires generated gmail oauth2 credentials.json
1. Run gmail credentials through `./host_files/create_google_token.py` to create token.json
1. High chance of emails getting into spam ...

| Variable                  | Mandatory |  type  |                            Description                                |
|---------------------------|-----------|--------|-----------------------------------------------------------------------|
| `SENDER`                  |   True    | `str`  | Sender's e-mail address                                               |
| `RECEIVERS`               |   True    | `str`  | Comma separated list of receivers

#### AWS SNS e-mail notifications
1. Requires some AWS setup (SNS topic, IAM non-root user recommended with SNS publish policy attached)

| Variable                  | Mandatory |  type  |                            Description                                |
|---------------------------|-----------|--------|-----------------------------------------------------------------------|
| `AWS_ACC_ID`              |   True    | `str`  | AWS account ID                                                        |
| `REGION`                  |   True    | `str`  | AWS region name                                                       |
| `AWS_ACCESS_KEY`          |   True    | `str`  | User's generated access key                                           |
| `AWS_SECRET_KEY`          |   True    | `str`  | User's generated secret key                                           |
#### MOCK notifications
Dumps mail content into logs.


## Prerequisites

### Docker
https://docs.docker.com/engine/install/debian/
https://docs.docker.com/engine/install/linux-postinstall/

### Memory limit
Memory limit support on RPI is disabled by default. In order to enable it edit `/boot/firmware/cmdline.txt`
adding the following to the end of the file: `cgroup_enable=memory swapaccount=1 cgroup_memory=1 cgroup_enable=cpuset`
and reboot

### gvfs-gphoto2-volume-monitor
Even the [author doesn't seem to know why this is started](https://github.com/gphoto/gphoto2/issues/181). It could probably be disabled in some event-driven way,
but this way takes much less dev time and is robust enough

1. Move `./host_files/gphoto2-volume-monitor-killer.sh` to intended location or use it directly:
1. run `chmod +x /path/to/bash_script.sh`
1. run `crontab -e`
1. Add the following to crontab: `@reboot sleep 20 && /path/to/bash_script.sh`
1. `sudo reboot now`

### Non-versioned files needed:
1. `.env` - described above
1. `docker-compose.yml` - generated by running `make compose` after filling out `.env` file
1. `credentials.json` - generated [Google Oauth2](https://developers.google.com/workspace/guides/create-credentials#web-application) credentials file.
1. `token.json` - token file generated by running `./host_files/create_google_token.py` - Needed only if `MAILBOX=GMAIL`

## How to
1. Create `.env` file with variables mentioned above
1. `make compose` - to generate compose file
1. `make build-base` before building images - needed just once
1. `make build` to build all
1. `make start` to start all
